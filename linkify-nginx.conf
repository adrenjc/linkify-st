user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
    worker_connections 1024;
    multi_accept on;
    use epoll;
}

http {
    # ================= 基础设置 =================
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    server_tokens off;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # ================= 日志设置 =================
    log_format detailed escape=json
    '{'
    '"time_local":"$time_local",'
    '"remote_addr":"$remote_addr",'
    '"request":"$request",'
    '"status": "$status",'
    '"body_bytes_sent":"$body_bytes_sent",'
    '"request_time":"$request_time",'
    '"http_referrer":"$http_referer",'
    '"http_user_agent":"$http_user_agent",'
    '"http_x_forwarded_for":"$http_x_forwarded_for",'
    '"upstream_response_time":"$upstream_response_time"'
    '}';

    access_log /var/log/nginx/access.log detailed;
    error_log /var/log/nginx/error.log;

    # ================= Gzip 压缩 =================
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 1k;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # ================= 限流配置 =================
    limit_req_zone $binary_remote_addr zone=api:20m rate=100r/s;
    limit_req_zone $binary_remote_addr zone=redirect:20m rate=200r/s;

    # ================= 上游服务 (Docker) =================
    # 后端 API 服务 (对应 docker-compose 中暴露的 5000 端口)
    upstream backend {
        server backend:5000;
        keepalive 100;
        keepalive_requests 1000;
        keepalive_timeout 60s;
    }

    # 前端静态服务 (对应 docker-compose 中暴露的 3000 端口)
    upstream frontend {
        server frontend:3000;
        keepalive 100;
    }

    # ================= SSL 配置 (通用) =================
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # ================= 主站点配置 =================
    server {
        listen 80;
        server_name your-domain.com;

        # 任何 HTTP 请求都可以在这里处理，Certbot 会自动添加 HTTPS 重定向
        
        # 1. 前端代理 (主界面)
        location / {
            proxy_pass http://frontend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 静态资源缓存控制
            expires 1h;
            add_header Cache-Control "public, no-transform";
        }

        # 2. 后端 API 代理
        location /api/ {
            proxy_pass http://backend/api/;
            proxy_http_version 1.1;
            proxy_set_header Connection "";

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # 禁用 API 缓存
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "-1";

            limit_req zone=api burst=100 nodelay;
        }

        # 3. 短链跳转代理 (主域名下的跳转)
        location ~* ^/r/(.+)$ {
            proxy_pass http://backend/api/r/$1;
            proxy_http_version 1.1;
            proxy_set_header Connection "";

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # 禁用跳转缓存 (防止修改短链后用户仍跳转旧地址)
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            limit_req zone=redirect burst=200 nodelay;
        }
    }

    # ================= 自定义域名配置 (泛解析) =================
    server {
        listen 80 default_server;
        server_name _;

        # ACME 验证 (用于 Let's Encrypt)
        location /.well-known/acme-challenge/ {
            root /var/www/html;
            try_files $uri =404;
        }

        # 只处理短链跳转 /r/xxxx
        location ~* ^/r/(.+)$ {
            proxy_pass http://backend/api/r/$1;
            proxy_http_version 1.1;
            proxy_set_header Connection "";

            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            limit_req zone=redirect burst=200 nodelay;
        }

        # 其他请求返回 404 (防止通过自定义域名访问后台)
        location / {
            return 404;
        }
    }

    # 引入其他配置 (如 Certbot 自动生成的 SSL 配置会放在 sites-enabled)
    # include /etc/nginx/conf.d/*.conf;
    # include /etc/nginx/sites-enabled/*;
}
